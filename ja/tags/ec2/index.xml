<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ec2 on DuiNaru | 開発と経験を載せるブログ</title><link>https://duinaru.github.io/ja/tags/ec2/</link><description>Recent content in ec2 on DuiNaru | 開発と経験を載せるブログ</description><generator>Hugo -- gohugo.io</generator><language>ja</language><lastBuildDate>Sun, 01 Dec 2019 12:03:06 +0000</lastBuildDate><atom:link href="https://duinaru.github.io/ja/tags/ec2/index.xml" rel="self" type="application/rss+xml"/><item><title>CloudWatchを利用し、一定時間内でSSHのコネクションがない場合はEC2を自動終了させる方法</title><link>https://duinaru.github.io/ja/posts/2019-12-01-stop-ec2-when-no-ssh-connection-for-a-while/</link><pubDate>Sun, 01 Dec 2019 12:03:06 +0000</pubDate><guid>https://duinaru.github.io/ja/posts/2019-12-01-stop-ec2-when-no-ssh-connection-for-a-while/</guid><description>主にCloud9で使用するEC2がSSHのコネクションがない場合は使用することがなく、一定時間を待機した後に自動終了されるように作りました。
EC2で実行されるスクリプトだけでも出来そうですが、AWSでSSHのモニタリングもできるようにCloudWatchを利用しました。
IAM User 作成 CloudWatchにSSHのコネクションの数を送信する役割のUserが必要です。
aws cliで接続が可能で、権限はCloudWatchAgentServerPolicyを持つUserを作成しました。
EC2にaws cliを設定 CloudWatchにSSHのコネクションの数を送るため、EC2にaws cliをインストールしてUserを設定します。
インストール aws cliをインストールします。
Install the AWS CLI version 1 on Linux
User設定 作ったUserで設定します。
Configuring the AWS CLI
SSHのコネクションの数を求める 繋がれているSSHを数を求めた後で、CloudWatchに送信することができるでしょう。
繋がっているユーザーを求める方法 who 上記のコマンドで現在に接続されているユーザーを求められます。
SSHで接続した場合、次のように確認できます。
しかし、Cloud9で接続した場合は何も出力されないことが確認できます。
Cloud9のコネクションは確認できない 何故でしょう。
Cloud9のSSH Host Requirementsを見れば、SSHの接続が要求されていて、SSHを利用することは確かのようです。
現在、実行されているSSHDの数を求める SSHで繋がれるようですので、実行しているSSHDを求めてみます。
ps -A x | grep &amp;quot;sshd&amp;quot; sshd: ubuntu [priv]とsshd: ubuntu@nottyがそれぞれ2個ずつ、4個が見えます。
SSHで接続するときにセキュリティー強化の一環でprivでプロセスを作り、子プロセスで処理させるようです。
UsePrivilegeSeparation
それで一つのSSHで二つのプロセスが作成されるようです。
では、現在は二つのSSHのコネクションがあるということが分かります。
次のコマンドでSSHのコネクションの数を求めます。
ps -A x | grep &amp;quot;sshd&amp;quot; | grep &amp;quot;\\[priv\\]&amp;quot; | wc -l SSH数を送信 求めたSSHの数がCloudWatchに送信されるようにします。</description></item><item><title>SSMとCloudWatchでログインする時、EC2が自動起動されるように設定</title><link>https://duinaru.github.io/ja/posts/2019-11-18-auto-start-ec2-on-sign-in/</link><pubDate>Mon, 18 Nov 2019 11:53:20 +0000</pubDate><guid>https://duinaru.github.io/ja/posts/2019-11-18-auto-start-ec2-on-sign-in/</guid><description>Cloud9を手動で作ったEC2で使用していまして、自動で作る時に使用できるEC2の自動起動のようにしたいと思いました。
しかし、Cloud9が始まる時にEC2をスタートさせることはできなくてConsoleにSign inする時、起動されるようにしました。
AWS System Manager EC2を起動させるためにSSMを利用します。
そのため、SSMがEC2を管理できるようにセットアップをしなければなりません。
IAM Role 作成 : AmazonSSMManagedInstanceCore EC2をSSMで使用できるようにIAM Roleを作成します。
AmazonSSMManagedInstanceCoreのpolicyを選択し、作ります。
作ったIAMを自動起動させようとするEC2にattachすればいいです。
Attaching an IAM Role to an Instance
上のリンクのようにすればいいです。
IAM Role 作成 : AmazonSSMAutomationRole 今度はSSMを実行する時に必要なIAM Roleを作成します。
AmazonSSMAutomationRoleのpolicyを選択し、作ります。
このroleは後で使います。
次はログインイベントが発生するとEC2が起動されるように設定します。
CloudTrail 設定 ログインイベントを使用するためにはCloudTrailを設定する必要があります。
CloudTrailの左メニューで Trails - Create Trail を選択しましょう。
作成し、設定を見るとLoggingがONになっていることが確認できます。
CloudTrailの設定が終わりました。
CloudWatchのRules設定 ログインイベントをCloudWatchで感知し、処理されるようにしましょう。
CloudWatchの左メニューで Rules - Creates rule を選択します。
Event Source Service NameはAWS Console Sign-inを選択します。</description></item><item><title>ruby on railsをec2に実装してみました。</title><link>https://duinaru.github.io/ja/posts/2019-11-14-set-up-ruby-on-rails-ec2/</link><pubDate>Thu, 14 Nov 2019 11:18:53 +0000</pubDate><guid>https://duinaru.github.io/ja/posts/2019-11-14-set-up-ruby-on-rails-ec2/</guid><description>rubyを知りましたので、rubyでウェブサイトを開発したくてruby on railsを始めました。
開発しながらruby on railsを学習する目的で、環境構築から始めました。
EC2 生成 AMI
ubuntu(Ubuntu Server 18.04 LTS (HVM), SSD Volume Type)を選びました。
他の設定はfree-tierができるようにしました。
Security groups
SSHができるように22ポートは可能にし、他はその時に解放します。
インストール SSHで接続し、インストールします。
Ruby on Rails の Getting Started with Rails を元に進めました。
パッケージアップデート sudo apt-get update Ruby インストール sudo apt-get install ruby-full Ruby バージョン確認 ruby -v railsで要求されるruby 2.5.0の以降のバージョンか確認します。
2.5.xですね。
sqlite3 インストール sudo apt-get install sqlite3 sqlite3 バージョン確認 sqlite3 --version rails インストール sudo gem install rails インストールのエラー Could not create Makefile due to some reason, probably lack of necessary libraries and/or headers.</description></item></channel></rss>