<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>alarm on DuiNaru | 開発と経験を載せるブログ</title><link>https://duinaru.github.io/ja/tags/alarm/</link><description>Recent content in alarm on DuiNaru | 開発と経験を載せるブログ</description><generator>Hugo -- gohugo.io</generator><language>ja</language><lastBuildDate>Sun, 01 Dec 2019 12:03:06 +0000</lastBuildDate><atom:link href="https://duinaru.github.io/ja/tags/alarm/index.xml" rel="self" type="application/rss+xml"/><item><title>CloudWatchを利用し、一定時間内でSSHのコネクションがない場合はEC2を自動終了させる方法</title><link>https://duinaru.github.io/ja/posts/2019-12-01-stop-ec2-when-no-ssh-connection-for-a-while/</link><pubDate>Sun, 01 Dec 2019 12:03:06 +0000</pubDate><guid>https://duinaru.github.io/ja/posts/2019-12-01-stop-ec2-when-no-ssh-connection-for-a-while/</guid><description>主にCloud9で使用するEC2がSSHのコネクションがない場合は使用することがなく、一定時間を待機した後に自動終了されるように作りました。
EC2で実行されるスクリプトだけでも出来そうですが、AWSでSSHのモニタリングもできるようにCloudWatchを利用しました。
IAM User 作成 CloudWatchにSSHのコネクションの数を送信する役割のUserが必要です。
aws cliで接続が可能で、権限はCloudWatchAgentServerPolicyを持つUserを作成しました。
EC2にaws cliを設定 CloudWatchにSSHのコネクションの数を送るため、EC2にaws cliをインストールしてUserを設定します。
インストール aws cliをインストールします。
Install the AWS CLI version 1 on Linux
User設定 作ったUserで設定します。
Configuring the AWS CLI
SSHのコネクションの数を求める 繋がれているSSHを数を求めた後で、CloudWatchに送信することができるでしょう。
繋がっているユーザーを求める方法 who 上記のコマンドで現在に接続されているユーザーを求められます。
SSHで接続した場合、次のように確認できます。
しかし、Cloud9で接続した場合は何も出力されないことが確認できます。
Cloud9のコネクションは確認できない 何故でしょう。
Cloud9のSSH Host Requirementsを見れば、SSHの接続が要求されていて、SSHを利用することは確かのようです。
現在、実行されているSSHDの数を求める SSHで繋がれるようですので、実行しているSSHDを求めてみます。
ps -A x | grep &amp;quot;sshd&amp;quot; sshd: ubuntu [priv]とsshd: ubuntu@nottyがそれぞれ2個ずつ、4個が見えます。
SSHで接続するときにセキュリティー強化の一環でprivでプロセスを作り、子プロセスで処理させるようです。
UsePrivilegeSeparation
それで一つのSSHで二つのプロセスが作成されるようです。
では、現在は二つのSSHのコネクションがあるということが分かります。
次のコマンドでSSHのコネクションの数を求めます。
ps -A x | grep &amp;quot;sshd&amp;quot; | grep &amp;quot;\\[priv\\]&amp;quot; | wc -l SSH数を送信 求めたSSHの数がCloudWatchに送信されるようにします。</description></item></channel></rss>